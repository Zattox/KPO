# Отчет по БДЗ-2, Тепляков Владислав Витальевич, БПИ2310

## Тестирование
1. Проверьте установку docker-compose и docker
    ```bash
   docker --version
   docker-compose --version
   ```
2. Перейдите в корневую папку проекта и пропишите для запуска проекта `docker-compose up --build`
3. Для ручного тестировния перейдите по адресу в браузере http://localhost:5000/swagger
4. Для остановки контейнеров `docker-compose down --volumes `
5. Тестовое покрытие не было создано

## Архитектурный обзор

### Компоненты системы
1. **API Gateway** (порт 5000) - центральный entry point
2. **File Storing Service** (порт 5001) - управление файлами
3. **File Analysis Service** (порт 5002) - обработка текста
4. **PostgreSQL** (порт 5432) - хранение данных

### Ключевые характеристики
- Четкое разделение ответственности
- Гибкая микросервисная архитектура
- Контейнеризация через Docker
- Полная документация API

## Функциональные возможности

### API Gateway
- **Маршрутизация** запросов между сервисами
- **Агрегация** данных из нескольких источников
- **Политики устойчивости**:
  - Retry (3 попытки)
  - Circuit Breaker (60 сек при 2 ошибках)
- **Логирование** всех операций через Serilog

### File Storing Service
- **Хранение** файлов в выделенной директории
- **Метаданные** в PostgreSQL
- **Валидация** содержимого (10MB max)
- **Хеширование** для обнаружения дубликатов

### File Analysis Service
- **Анализ текста**:
  - Подсчет абзацев, слов, символов
  - Генерация хеш-сумм (SHA-256)
- **Обнаружение плагиата**
- **Хранение** результатов анализа

## Инфраструктура и развертывание

### Базовая конфигурация
- **Изолированная сеть** (bridge)
- **Две БД** в одном PostgreSQL:
  - filestoring_db
  - fileanalysis_db
- **Автоматическая инициализация** через SQL-скрипт

### Особенности работы
1. **Healthcheck** для всех компонентов
2. **Volumes** для:
   - Данных PostgreSQL
   - Файловых хранилищ
   - Логов сервисов
3. **Переменные окружения** для конфигурации

## Детали реализации

### 1. API Gateway (`AnalyzeController.cs`)

**Основные функции:**
- Маршрутизация запросов между сервисами
- Агрегация данных из нескольких сервисов
- Обработка ошибок и retry-логика

**Ключевые особенности:**
- Использует `IHttpClientFactory` для создания клиентов к другим сервисам
- Реализует политики устойчивости:
  - Retry Policy (3 попытки с экспоненциальной задержкой)
  - Circuit Breaker (размыкание цепи после 2 ошибок на 60 секунд)
- Логирование через Serilog
- Ограничение размера файла (10MB)

**Методы:**
- `POST /files/upload` - загрузка и анализ файла
- `GET /files/list` - получение списка файлов с статистикой
- `GET /files/content/{id}` - получение содержимого файла
- `GET /files/stats/{id}` - получение статистики файла
- `DELETE /files/remove/{id}` - удаление файла и статистики

### 2. File Analysis Service (`AnalysisController.cs`)

**Основные функции:**
- Анализ текстовых файлов
- Проверка на плагиат
- Хранение результатов анализа

**Ключевые особенности:**
- Использует Entity Framework Core для работы с PostgreSQL
- Реализует те же политики устойчивости, что и API Gateway
- Анализирует:
  - Количество абзацев
  - Количество слов
  - Количество символов
  - Хеш-сумму содержимого (SHA-256)

**Методы:**
- `GET /analyze/{fileId}` - анализ файла
- `GET /analyze/list` - список всех анализов
- `DELETE /analyze/remove/{fileId}` - удаление анализа

### 3. File Storing Service (`FilesController.cs`)

**Основные функции:**
- Хранение файлов на диске
- Управление метаданными файлов
- Проверка уникальности содержимого

**Ключевые особенности:**
- Сохраняет файлы в папку `uploads`
- Хранит метаданные в PostgreSQL
- Проверяет валидность текстового содержимого
- Вычисляет хеш-сумму для обнаружения дубликатов
- Ограничение размера файла (10MB)

**Методы:**
- `POST /store/upload` - загрузка файла
- `GET /store/list` - список всех файлов
- `GET /store/{id}` - получение файла
- `GET /store/content/{id}` - получение содержимого файла
- `DELETE /store/remove/{id}` - удаление файла

## Взаимодействие сервисов

### Основные сценарии
1. **Загрузка файла**:
   Клиент → Gateway → FileStorage → FileAnalysis

2. **Получение статистики**:
   Клиент → Gateway → FileAnalysis

3. **Удаление данных**:
   Клиент → Gateway → (FileStorage + FileAnalysis)

### Коммуникация
- **Внутренний DNS** для service discovery
- **HTTP-клиенты** с таймаутом 30 сек
- **Согласованные** форматы запросов/ответов

## Заключение

Реализованная система предоставляет:
- Модульную архитектуру с четкими границами
- Отказоустойчивые механизмы обработки
- Гибкую инфраструктуру развертывания
- Полный цикл работы с текстовыми данными