# Краткий отчет

## Описание архитектуры системы
Система представляет собой микросервисную архитектуру, разработанную для анализа текстовых отчетов студентов на плагиат и статистическую обработку данных. Архитектура состоит из трех микросервисов, каждый из которых выполняет строго определенные функции, что обеспечивает четкое разделение ответственности:

1. **API Gateway** (TextScanner.Apidateway):
   - Отвечает за маршрутизацию запросов от клиента к соответствующим микросервисам.
   - Выполняет роль единой точки входа для всех запросов.
   - Использует `HttpClient` для пересылки запросов к `FileStoringService` и `FileAnalysisService`.  
   - Порт: 5000.

2. **File Storing Service** (TextScanner.FileStoringService):
   - Отвечает за хранение и выдачу файлов отчетов в формате `.txt`.  
   - Сохраняет файлы на диск (в папку `/app/Files`) и метаданные в базе данных PostgreSQL.  
   - Выполняет базовые операции: загрузка, получение списка файлов, получение статистики, удаление.  
   - Вычисляет хэш файла (SHA-256) для проверки на плагиат.  
   - Порт: 5001.

3. **File Analysis Service** (TextScanner.FileAnalysisService):
   - Отвечает за анализ текстовых файлов: подсчет количества абзацев, слов, символов.  
   - Сохраняет результаты анализа в базе данных PostgreSQL.  
   - Использует `HttpClient` для взаимодействия с `FileStoringService` (например, для получения содержимого файла).  
   - Порт: 5002.

## База данных
- Используется PostgreSQL для хранения метаданных файлов (`FileMetadatas` в `FileStoringService`) и результатов анализа (`AnalysisResults` в `FileAnalysisService`).
- Две базы данных: `filestoring` и `fileanalysis`.

## Сетевое взаимодействие
- Микросервисы объединены в сеть `textscanner-network` (тип `bridge`) через `docker-compose.yml`.
- Переменные окружения (`SERVICES_FILESTORINGSERVICE`, `SERVICES_FILEANALYSISSERVICE`) задают URL для межсервисного взаимодействия.

## Обработка ошибок
- Использованы проверки состояния сервисов через `depends_on` + `condition: service_healthy` для PostgreSQL.
- Логирование ошибок реализовано через Serilog (логи сохраняются в `/app/logs`).

## Дополнительно
- Функциональность облака слов не реализована, так как является необязательной.
- Покрытие тестами не реализовано (требуется дополнительная работа для достижения 65% покрытия).

## Спецификация API
API предоставляется через `TextScanner.Apidateway` и документируется с помощью Swagger (доступен по адресу `http://localhost:5000/swagger`). Все запросы маршрутизируются через API Gateway к соответствующим микросервисам.

## Конечные точки API

### 1. Загрузка файла
- **Метод**: `POST /files/upload`
- **Описание**: Загружает файл `.txt` для хранения и анализа.
- **Заголовки**:
  - `Content-Type: multipart/form-data`
- **Тело запроса**:
  - `file` (тип: `file`) — файл в формате `.txt`.
- **Ответ**:
  - `200 OK`:
    ```json
    {
      "fileId": "guid",
      "filename": "string",
      "hash": "string"
    }
    ```
  - `400 Bad Request`: Если файл пустой или не в формате `.txt`.
  - `500 Internal Server Error`: Если `FileStoringService` или `FileAnalysisService` недоступны.

### 2. Получение списка файлов
- **Метод**: `GET /files/list`
- **Описание**: Возвращает список всех загруженных файлов.
- **Ответ**:
  - `200 OK`:
    ```json
    [
      {
        "fileId": "guid",
        "filename": "string",
        "hash": "string"
      }
    ]
    ```
  - `500 Internal Server Error`: Если `FileStoringService` недоступен.

### 3. Получение статистики файла
- **Метод**: `GET /files/stats/{fileId}`
- **Описание**: Возвращает статистику анализа файла (абзацы, слова, символы).
- **Параметры**:
  - `fileId` (путь, тип: `guid`) — идентификатор файла.
- **Ответ**:
  - `200 OK`:
    ```json
    {
      "fileId": "guid",
      "paragraphCount": 0,
      "wordCount": 0,
      "characterCount": 0,
      "hash": "string"
    }
    ```
  - `404 Not Found`: Если файл или анализ не найдены.
  - `500 Internal Server Error`: Если `FileAnalysisService` недоступен.

### 4. Удаление файла
- **Метод**: `DELETE /files/remove/{fileId}`
- **Описание**: Удаляет файл и связанные с ним данные.
- **Параметры**:
  - `fileId` (путь, тип: `guid`) — идентификатор файла.
- **Ответ**:
  - `204 No Content`: Успешное удаление.
  - `404 Not Found`: Если файл не найден.
  - `500 Internal Server Error`: Если `FileStoringService` или `FileAnalysisService` недоступны.

## Примечания
- Все запросы проходят через API Gateway, который перенаправляет их к соответствующим сервисам.
- API Gateway логирует запросы и ошибки через Serilog.

## Итог
Отчет включает краткое описание архитектуры системы (разделение на три микросервиса, сетевое взаимодействие, обработка ошибок) и спецификацию API (конечные точки, форматы запросов/ответов). Swagger-документация доступна для проверки функциональности.